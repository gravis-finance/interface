stages:
    - build
    - deploy
    - test
    - allure
    - allure-report-deploy

build_develop:
    stage: build
    only:
        - develop
    image: node:14-buster
    tags: &b_runner 
        - builder
        - docker-executor
    script:
        - yarn global add dotenv-cli
        - yarn install
        - yarn build:dev
    artifacts:
        expire_in: 1 week
        paths:
            - build

deploy_develop:
    stage: deploy
    only:
        - develop
    tags: 
      - shell
      - dev
      - deploy-runner
    script:
        - rsync -a ./build/* /var/www/swap-interface/dev

build_stage:
    stage: build
    only:
        - stage
        - autotests
    image: node:14-buster
    tags: &b_runner 
        - builder
        - docker-executor
    script:
        - yarn global add dotenv-cli
        - yarn install
        - yarn build
    artifacts:
        expire_in: 1 week
        paths:
            - build

deploy_stage:
    stage: deploy
    only:
        - stage
        - autotests
    tags: 
      - shell
      - dev
      - deploy-runner
    script:
        - rsync -a ./build/* /var/www/swap-interface-stage

build_production:
    stage: build
    only:
        - master
    image: node:14-buster
    tags: &b_runner
        - builder
        - docker-executor
    script:
        - yarn global add dotenv-cli
        - yarn install
        - yarn build
    artifacts:
        expire_in: 1 week
        paths:
            - build

deploy_production:
    stage: deploy
    only:
        - master
    tags:
        - shell
        - prod
        - deploy-runner
    when: manual
    script:
        - rsync -a ./build/* /var/www/swap-interface/build

stage_autotest:
    stage: test
    only:
        - autotests
    image: cypress/browsers:node16.14.2-slim-chrome100-ff99-edge
    tags: &b_runner 
        - builder
        - docker-executor
    script:
        - yarn install
        - yarn cy:run
    allow_failure: true
    artifacts:
        when: always
        expire_in: 1 week
        paths:
            - allure-results/

stage-report:
    stage: allure
    only:
        - autotests
    image: gradle:jdk8
    tags: &b_runner 
        - builder
        - docker-executor
    before_script:
        - apt-get update
        - apt-get install -y default-jdk wget unzip 
        - mkdir /work/
        - wget https://github.com/allure-framework/allure2/releases/download/2.13.8/allure-2.13.8.zip -P /work/
        - unzip /work/allure-2.13.8.zip -d /work/
    script:
        - /work/allure-2.13.8/bin/allure generate allure-results --clean -o allure-report
    artifacts:
        when: always
        expire_in: 1 week
        paths:
            - allure-results/
            - allure-report/

deploy_stage-report:
    stage: allure-report-deploy
    only:
        - stage
        - autotests
    tags: 
      - shell
      - dev
      - deploy-runner
    script:
        - mkdir -p /var/www/swap-interface-stage/reports/${CI_PIPELINE_ID}
        - cp -R ./allure-report/* /var/www/swap-interface-stage/reports/${CI_PIPELINE_ID}
